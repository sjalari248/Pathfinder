<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Planner</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    
<div id="container">
    <div id="section1">
        <h1 class="underlineText" id="header">High School Class Planner</h1>
        <h3 style="margin-bottom: 50px; margin-top: 15px;">
            It's hard trying to figure out what classes to take and which classes would fit you best. This tool allows you to
            do that easily! Just enter in the required info and choose what year you're in.
        </h3>

        <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px;">
            <div style="width: 49.5%; position: relative; display: flex; flex-direction: column; align-items: end; align-items: end;">
                <p style="margin-bottom: 10px;">Upload Your Course Catalog</p>
                <label for="courseCatalog" id="custom-file-label">
                    <p id="uploadText">Upload PDF File</p>
                    <div id="downloadIcon"></div>
                </label>
                <input type="file" id="courseCatalog" class="hidden-file-input" accept="application/pdf">

                <script>
                    document.getElementById("courseCatalog").addEventListener("change", function() {
                        if (this.files.length > 0) {
                            let fileName = this.files[0].name; 
                            document.getElementById("downloadIcon").style.backgroundImage = "url(/images/uploadDone.svg)"
                        }
                    });
                </script>
            </div>
            <div style="width: 49.5%;">
                <p style="margin-bottom: 10px;">Field of Interest</p>
                <select id="interest" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    <option disabled selected>Select Field of Interest</option>
                    <option>Engineering</option>
                    <option>Computer Science</option>
                    <option>Medicine</option>
                    <option>Art</option>
                    <option>Business</option>
                    <option>Humanities</option>
                    <option>No Specific Interest</option>
                </select>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px;">
            <div style="width: 49.5%;">
                <p style="margin-bottom: 10px;">Target University/College</p>
                <select id="collegeSearch">
                </select>
            </div>
            <div style="width: 49.5%;">
                <p style="margin-bottom: 10px;">Most Recently Completed Math Class</p>
                <select id="mathClass" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    <option disabled selected>Select Class</option>
                    <option>Grade 8 Mathematics</option>
                    <option>Algebra I</option>
                    <option>Geometry</option>
                    <option>Algebra II</option>
                    <option>Precalculus</option>
                    <option>Calculus</option>
                </select>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <label for="difficulty" style="margin: 0;">Class Difficulty Preference:</label>
            <span id="difficultyValue" style="margin-left: -10px; display: inline-block; width: 50px; text-align: right;">50%</span>
        </div>
        <input type="range" id="difficultySlider" min="1" max="100" value="50" style="margin-bottom: 15px;">

        <p>Find results for each grade</p>
        <br>
        <div style="display: flex; width: 100%; justify-content: space-between;">
            <button onclick="gradeSelected(9)" style="margin: 0px 5px 0px 0px;">Freshman</button>
            <button onclick="gradeSelected(10)" style="margin: 0px 5px 0px 5px;">Sophomore</button>
            <button onclick="gradeSelected(11)" style="margin: 0px 5px 0px 5px;">Junior</button>
            <button onclick="gradeSelected(12)" style="margin: 0px 0px 0px 5px;">Senior</button>
        </div>
    </div>

    <div id="section2">
        <h3 class="courseDisplay">Course 1</h3>
        <div class="divider"></div>
        <h3 class="courseDisplay">Course 2</h3>
        <div class="divider"></div>
        <h3 class="courseDisplay">Course 3</h3>
        <div class="divider"></div>
        <h3 class="courseDisplay">Course 4</h3>
        <div class="divider"></div>
        <h3 class="courseDisplay">Course 5</h3>
        <div class="divider"></div>
        <h3 class="courseDisplay">Course 6</h3>
    </div>
</div>

<script>

    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

    
    let pdfText = null;

    $(document).ready(function() {
        $('#collegeSearch').select2({
    placeholder: "Search College/University",
    width: '90%',
    allowClear: true,
    ajax: {
        url: 'https://api.data.gov/ed/collegescorecard/v1/schools.json',
        dataType: 'json',
        data: function (params) {
            return {
                api_key: 'Bu6Pku0B3kW9OTGe9j4ONHhL807YTmKFghvC7IHc',
                'school.name': params.term,
                per_page: 20
            };
        },
        processResults: function (data) {
            if (!data.results) {
                console.error("API Response Error:", data);
                return { results: [] };
            }
            return {
                results: data.results.map(function(school) {
                    return { id: school.id, text: school.school.name };
                })
            };
        },
        cache: true
    },
    minimumInputLength: 3
});
    });

    function updateDifficultyPercentage() {
        let slider = document.getElementById("difficultySlider");
        let display = document.getElementById("difficultyValue");
        display.textContent = slider.value + "%";
    }

    document.getElementById("difficultySlider").addEventListener("input", updateDifficultyPercentage);
    setInterval(updateDifficultyPercentage, 100);

    document.getElementById("courseCatalog").addEventListener("change", function() {
            if (this.files.length > 0) {
                let fileName = this.files[0].name;
                
                const maxLength = 30;
                if (fileName.length > maxLength) {
                    const extension = fileName.split('.').pop();
                    fileName = fileName.substring(0, maxLength - extension.length - 3) + "... ." + extension;
                }
                
                document.getElementById("uploadText").textContent = fileName;
            }
        });

    document.addEventListener("DOMContentLoaded", function () {
        const pdfInput = document.getElementById("courseCatalog");
        pdfInput.addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (file) {
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(fileReader.result);
                    try {
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let extractedText = "";
                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            const content = await page.getTextContent();
                            extractedText += content.items.map(item => item.str).join(" ") + "\n";
                        }
                        pdfText = extractedText.trim();
                        console.log("Extracted PDF Text:", pdfText);
                    } catch (error) {
                        console.error("Error extracting PDF text:", error);
                    }
                };
                fileReader.readAsArrayBuffer(file);
            }
        });
    });

async function gradeSelected(grade) {

  console.log("Fetching recommendations...");
      // Loading indicator
        // I used copilot
                            // Create and append the loader
                            const loader = document.createElement('div');
                            loader.className = 'loader';
                            loader.id = 'recommendation-loader'; // Add an ID to easily remove it later
                            document.getElementById('container').style.filter = 'blur(5px)';
                            document.body.appendChild(loader);

                            // Disable all interactive elements
                            const interactiveElements = document.querySelectorAll('button, select, input, textarea, a');
                            interactiveElements.forEach(element => {
                                element.disabled = true;
                            });

                            // Re-enable interactive elements
                            function enableInteractiveElements() {
                                interactiveElements.forEach(element => {
                                    element.disabled = false;
                                });
                            }

                            
                            if (!pdfText) {
                                alert("Please upload a course catalog PDF.");
                                // Remove the loader if no PDF
                                document.getElementById('recommendation-loader').remove();
                                return;
                            }

                            try {
                                await new Promise(resolve => setTimeout(resolve, 5000));
                                const recommendations = ["Class 1", "Class 2", "Class 3", "Class 4", "Class 5", "Class 6"] //placeholder
                                console.log("Recommended Courses:", recommendations);
                            } catch (error) {
                                console.error("Error getting recommendations:", error);
                                alert("An error occurred while processing your request.");

                            } finally {
                                // Remove the loader in finally block to ensure it's always removed
                                const loaderElement = document.getElementById('recommendation-loader');
                                if (loaderElement) {
                                    loaderElement.remove();
                                }
                                document.getElementById('container').style.filter = 'none';
                                enableInteractiveElements(); // Re-enable interactive elements
                            }                           


  const userInterest = document.getElementById("interest").value;
  const userCollege = document.getElementById("collegeSearch").value;
  const userMath = document.getElementById("mathClass").value;
  const userDifficulty = document.getElementById("difficultySlider").value;

  const systemPrompt = "You are an AI that recommends exactly six classes. If the user is in 12th grade, recommend 2 core classes and 4 electives. Otherwise, 4 core classes and 2 electives. Provide nothing else. ONLY 6 CLASSES SHOULD BE RECOMMENDED TOTAL NO MATTER WHAT";
  const userPrompt = "Interest: " + userInterest +
    "\nCollege: " + userCollege +
    "\nGrade: " + grade +
    "\nMath Completed: " + userMath +
    "\nDifficulty: " + userDifficulty;

  const body = {
    providers: ["openai"],
    messages: [
      {
        role: "system",
        content: [
          { type: "text", content: { text: systemPrompt } }
        ]
      },
      {
        role: "user",
        content: [
          { type: "text", content: { text: userPrompt } }
        ]
      }
    ]
  };

  if (pdfText) {
    body.messages.push({
      role: "user",
      content: [
        { type: "text", content: { text: "Course Catalog Content: " + pdfText } }
      ]
    });
  }

  body.messages.push({
    role: "user",
    content: [
      { type: "text", content: { text: "Please make sure that 1 English class is recommended. ONLY 6 CLASSES SHOULD BE RECOMMENDED TOTAL NO MATTER WHAT" } }
    ]
  });

  console.log("Request Body:", JSON.stringify(body, null, 2));

  try {
    const response = await fetch("https://api.edenai.run/v2/multimodal/chat", {
      method: "POST",
      headers: {
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMjFiNDYzNDEtZmRjMy00NzBkLTllNGYtMTUyOTI3ZWFhYTJlIiwidHlwZSI6ImFwaV90b2tlbiJ9._w69x9g-So4O1Ul7P3u9dekwKnSjWnwViqqzAwLvYHE",
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    const responseData = await response.json();

    if (!response.ok) {
      console.error("API Error:", responseData);
      alert("API request failed: " + JSON.stringify(responseData));
      return;
    }

    if (!responseData.openai || !responseData.openai.generated_text) {
      console.error("No recommendations returned from API");
      alert("No recommendations available.");
      return;
    }

    const recommendationsText = responseData.openai.generated_text.trim();
    const recommendations = recommendationsText.split("\n").map(course => course.trim()).filter(course => course);

    if (recommendations.length !== 6) {
      alert("Unexpected number of recommendations received: " + recommendations.length);
      return;
    }

    const courseElements = document.querySelectorAll("#section2 .courseDisplay");
    courseElements.forEach((elem, index) => {
      elem.textContent = recommendations[index];
    });
  } catch (error) {
    console.error("Error during recommendation request:", error);
    alert("An error occurred while processing your request.");
  }
}

</script>
</body>
</html>
